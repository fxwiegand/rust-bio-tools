<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <style>
            body {
                text-align: center;
            }
            #oncoprint {
                text-align: center;
            }
        </style>
        <title>Oncoprint (only recurrent genes)</title>
    </head>
    <body>
        <div id="oncoprint"></div>

        <script>
            {{ "https://cdn.jsdelivr.net/npm/vega@5.10.1"|embed_source|safe }}
        </script>
        <script>
            {{ "https://cdn.jsdelivr.net/npm/vega-lite@4.10.4"|embed_source|safe }}
        </script>
        <script>
            {{ "https://cdn.jsdelivr.net/npm/vega-embed@6.5.2"|embed_source|safe }}
        </script>

        <script>
            var spec = {
                "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
                "data": {
                    "values": {{ data|safe }}
                },
                "autosize": {
                    "type": "fit",
                    "contains": "padding"
                },
                "spacing": 15,
                "vconcat": [{
                    "mark": "bar",
                    "height": 100,
                    "encoding": {
                    "x": {
                        "field": "sample",
                        "type": "ordinal",
                        "scale": {},
                        "axis": null,
                        "sort": {
                            "op": "valid",
                            "field": "variants",
                            "order": "descending"
                        }
                    },
                    "y": {
                        "field": "variants",
                        "aggregate": "count",
                        "type": "quantitative"
                    },
                    "color": {
                        "field": "variants",
                        "type": "nominal",
                        "title": "Variants",
                        "scale": {
                            "domain": ["SNV", "MNV", "DEL", "INS", "DUP", "INV", "BND", "Complex"],
                            "range": ["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00"],
                            "type": "ordinal"
                            }
                        }
                    }
                },
                {
                    "spacing": 15,
                    "bounds": "flush",
                    "hconcat": [{
                        "layer": [
                            {
                                "mark": {
                                    "type": "square",
                                    "size": 350,
                                    "opacity": 1
                                },
                                "selection": {
                                    "highlight1": {"type": "single", "empty": "none", "on": "mouseover", "fields": ["gene"]}
                                },
                                "encoding": {
                                    "x": {
                                        "field": "sample",
                                        "type": "ordinal",
                                        "scale": {},
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "y": {
                                        "field": "gene",
                                        "type": "ordinal",
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "fillOpacity": {
                                        "condition": {"selection": "highlight1", "value": 0.8},
                                        "value": 1
                                    },
                                    "color": {
                                        "field": "variants1",
                                        "type": "nominal",
                                        "title": "Variants",
                                        "scale": {
                                            "domain": ["SNV", "MNV", "DEL", "INS", "DUP", "INV", "BND", "Complex"],
                                            "range": ["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00"],
                                            "type": "ordinal"
                                        }
                                    },
                                    "tooltip": [
                                        {"field":"gene", "type": "nominal"},
                                        {"field":"sample", "type": "nominal"},
                                        {"field":"dna_alterations", "type": "nominal"},
                                        {"field":"protein_alterations", "type": "nominal"},
                                        {"field":"variants", "type": "ordinal"}
                                    ],
                                }
                            },
                            {
                                "mark": {
                                    "type": "square",
                                    "size": 260,
                                    "opacity": 1
                                },
                                "selection": {
                                    "highlight2": {"type": "single", "empty": "none", "on": "mouseover", "fields": ["gene"]}
                                },
                                "encoding": {
                                    "x": {
                                        "field": "sample",
                                        "type": "ordinal",
                                        "scale": {},
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "y": {
                                        "field": "gene",
                                        "type": "ordinal",
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "fillOpacity": {
                                        "condition": {"selection": "highlight2", "value": 0.8},
                                        "value": 1
                                    },
                                    "color": {
                                        "field": "variants2",
                                        "type": "nominal",
                                        "title": "Variants",
                                        "scale": {
                                            "domain": ["SNV", "MNV", "DEL", "INS", "DUP", "INV", "BND", "Complex"],
                                            "range": ["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00"],
                                            "type": "ordinal"
                                        }
                                    },
                                    "tooltip": [
                                        {"field":"gene", "type": "nominal"},
                                        {"field":"sample", "type": "nominal"},
                                        {"field":"dna_alterations", "type": "nominal"},
                                        {"field":"protein_alterations", "type": "nominal"},
                                        {"field":"variants", "type": "ordinal"}
                                    ],
                                }
                            },
                            {
                                "mark": {
                                    "type": "square",
                                    "size": 220,
                                    "opacity": 1
                                },
                                "selection": {
                                    "highlight3": {"type": "single", "empty": "none", "on": "mouseover", "fields": ["gene"]}
                                },
                                "encoding": {
                                    "x": {
                                        "field": "sample",
                                        "type": "ordinal",
                                        "scale": {},
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "y": {
                                        "field": "gene",
                                        "type": "ordinal",
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "fillOpacity": {
                                        "condition": {"selection": "highlight3", "value": 0.8},
                                        "value": 1
                                    },
                                    "color": {
                                        "field": "variants3",
                                        "type": "nominal",
                                        "title": "Variants",
                                        "scale": {
                                            "domain": ["SNV", "MNV", "DEL", "INS", "DUP", "INV", "BND", "Complex"],
                                            "range": ["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00"],
                                            "type": "ordinal"
                                        }
                                    },
                                    "tooltip": [
                                        {"field":"gene", "type": "nominal"},
                                        {"field":"sample", "type": "nominal"},
                                        {"field":"dna_alterations", "type": "nominal"},
                                        {"field":"protein_alterations", "type": "nominal"},
                                        {"field":"variants", "type": "ordinal"}
                                    ],
                                }
                            },
                            {
                                "mark": {
                                    "type": "square",
                                    "size": 180,
                                    "opacity": 1
                                },
                                "selection": {
                                    "highlight4": {"type": "single", "empty": "none", "on": "mouseover", "fields": ["gene"]}
                                },
                                "encoding": {
                                    "x": {
                                        "field": "sample",
                                        "type": "ordinal",
                                        "scale": {},
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "y": {
                                        "field": "gene",
                                        "type": "ordinal",
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "fillOpacity": {
                                        "condition": {"selection": "highlight4", "value": 0.8},
                                        "value": 1
                                    },
                                    "color": {
                                        "field": "variants4",
                                        "type": "nominal",
                                        "title": "Variants",
                                        "scale": {
                                            "domain": ["SNV", "MNV", "DEL", "INS", "DUP", "INV", "BND", "Complex"],
                                            "range": ["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00"],
                                            "type": "ordinal"
                                        }
                                    },
                                    "tooltip": [
                                        {"field":"gene", "type": "nominal"},
                                        {"field":"sample", "type": "nominal"},
                                        {"field":"dna_alterations", "type": "nominal"},
                                        {"field":"protein_alterations", "type": "nominal"},
                                        {"field":"variants", "type": "ordinal"}
                                    ],
                                }
                            },
                            {
                                "mark": {
                                    "type": "square",
                                    "size": 140,
                                    "opacity": 1
                                },
                                "selection": {
                                    "highlight5": {"type": "single", "empty": "none", "on": "mouseover", "fields": ["gene"]}
                                },
                                "encoding": {
                                    "x": {
                                        "field": "sample",
                                        "type": "ordinal",
                                        "scale": {},
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "y": {
                                        "field": "gene",
                                        "type": "ordinal",
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "fillOpacity": {
                                        "condition": {"selection": "highlight5", "value": 0.8},
                                        "value": 1
                                    },
                                    "color": {
                                        "field": "variants5",
                                        "type": "nominal",
                                        "title": "Variants",
                                        "scale": {
                                            "domain": ["SNV", "MNV", "DEL", "INS", "DUP", "INV", "BND", "Complex"],
                                            "range": ["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00"],
                                            "type": "ordinal"
                                        }
                                    },
                                    "tooltip": [
                                        {"field":"gene", "type": "nominal"},
                                        {"field":"sample", "type": "nominal"},
                                        {"field":"dna_alterations", "type": "nominal"},
                                        {"field":"protein_alterations", "type": "nominal"},
                                        {"field":"variants", "type": "ordinal"}
                                    ],
                                }
                            },
                            {
                                "mark": {
                                    "type": "square",
                                    "size": 100,
                                    "opacity": 1
                                },
                                "selection": {
                                    "highlight6": {"type": "single", "empty": "none", "on": "mouseover", "fields": ["gene"]}
                                },
                                "encoding": {
                                    "x": {
                                        "field": "sample",
                                        "type": "ordinal",
                                        "scale": {},
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "y": {
                                        "field": "gene",
                                        "type": "ordinal",
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "fillOpacity": {
                                        "condition": {"selection": "highlight6", "value": 0.8},
                                        "value": 1
                                    },
                                    "color": {
                                        "field": "variants6",
                                        "type": "nominal",
                                        "title": "Variants",
                                        "scale": {
                                            "domain": ["SNV", "MNV", "DEL", "INS", "DUP", "INV", "BND", "Complex"],
                                            "range": ["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00"],
                                            "type": "ordinal"
                                        }
                                    },
                                    "tooltip": [
                                        {"field":"gene", "type": "nominal"},
                                        {"field":"sample", "type": "nominal"},
                                        {"field":"dna_alterations", "type": "nominal"},
                                        {"field":"protein_alterations", "type": "nominal"},
                                        {"field":"variants", "type": "ordinal"}
                                    ],
                                }
                            },
                            {
                                "mark": {
                                    "type": "square",
                                    "size": 60,
                                    "opacity": 1
                                },
                                "selection": {
                                    "highlight7": {"type": "single", "empty": "none", "on": "mouseover", "fields": ["gene"]}
                                },
                                "encoding": {
                                    "x": {
                                        "field": "sample",
                                        "type": "ordinal",
                                        "scale": {},
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "y": {
                                        "field": "gene",
                                        "type": "ordinal",
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "fillOpacity": {
                                        "condition": {"selection": "highlight7", "value": 0.8},
                                        "value": 1
                                    },
                                    "color": {
                                        "field": "variants7",
                                        "type": "nominal",
                                        "title": "Variants",
                                        "scale": {
                                            "domain": ["SNV", "MNV", "DEL", "INS", "DUP", "INV", "BND", "Complex"],
                                            "range": ["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00"],
                                            "type": "ordinal"
                                        }
                                    },
                                    "tooltip": [
                                        {"field":"gene", "type": "nominal"},
                                        {"field":"sample", "type": "nominal"},
                                        {"field":"dna_alterations", "type": "nominal"},
                                        {"field":"protein_alterations", "type": "nominal"},
                                        {"field":"variants", "type": "ordinal"}
                                    ],
                                }
                            },
                            {
                                "mark": {
                                    "type": "square",
                                    "size": 20,
                                    "opacity": 1
                                },
                                "selection": {
                                    "highlight8": {"type": "single", "empty": "none", "on": "mouseover", "fields": ["gene"]}
                                },
                                "encoding": {
                                    "x": {
                                        "field": "sample",
                                        "type": "ordinal",
                                        "scale": {},
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "y": {
                                        "field": "gene",
                                        "type": "ordinal",
                                        "sort": {
                                            "op": "valid",
                                            "field": "variants",
                                            "order": "descending"
                                        }
                                    },
                                    "fillOpacity": {
                                        "condition": {"selection": "highlight8", "value": 0.8},
                                        "value": 1
                                    },
                                    "color": {
                                        "field": "variants8",
                                        "type": "nominal",
                                        "title": "Variants",
                                        "scale": {
                                            "domain": ["SNV", "MNV", "DEL", "INS", "DUP", "INV", "BND", "Complex"],
                                            "range": ["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00"],
                                            "type": "ordinal"
                                        }
                                    },
                                    "tooltip": [
                                        {"field":"gene", "type": "nominal"},
                                        {"field":"sample", "type": "nominal"},
                                        {"field":"dna_alterations", "type": "nominal"},
                                        {"field":"protein_alterations", "type": "nominal"},
                                        {"field":"variants", "type": "ordinal"}
                                    ],
                                }
                            }
                        ]
                    },
                    {
                    "mark": "bar",
                    "width": 100,
                    "encoding": {
                        "y": {
                            "field": "gene",
                            "type": "ordinal",
                            "sort": {
                                "op": "valid",
                                "field": "variants",
                                "order": "descending"
                            },
                            "axis": null
                        },
                        "x": {
                            "field": "variants",
                            "aggregate": "count",
                            "type": "quantitative"
                        },
                        "color": {
                            "field": "variants",
                            "type": "nominal",
                            "title": "Variants",
                            "scale": {
                                "domain": ["SNV", "MNV", "DEL", "INS", "DUP", "INV", "BND", "Complex"],
                                "range": ["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00"],
                                "type": "ordinal"
                            }
                        }
                    }
                    }]
                }]
            };
            let changed_records = []
            let delete_records = []
            spec.data.values.forEach(function(record, j) {
                let variants = record.variants.split("/");
                if (variants.length > 1) {
                    for (var i = 0; i < variants.length; i++) {
                        let field = "variants" + (i+1);
                        let layer_record = JSON.parse(JSON.stringify(record));
                        layer_record[field] = variants[i];
                        changed_records.push(layer_record);
                    }
                    delete_records.push(j);
                } else {
                    record.variants1 = record.variants;
                }
            });
            for (let i = 0; i < delete_records.length; i++) {
                console.log(spec.data.values[delete_records[i]-i]);
                spec.data.values.splice(delete_records[i]-i, 1);
            }
            changed_records.forEach(function(record) {
                spec.data.values.push(record);
            });
            vegaEmbed('#oncoprint', spec).then(function(result) {
                result.view.addEventListener('click', function(event, item) {
                    window.location.href = 'genes/' + item.datum.gene + '.html';
                });
            });

        </script>
    </body>
</html>